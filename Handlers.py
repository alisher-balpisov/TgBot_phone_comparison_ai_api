from aiogram import Router
from aiogram.types import Message
from aiogram.filters import Command
from Client import client

router = Router()

@router.message(Command("start"))
async def send_welcome(message: Message):
    await message.reply("–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤. "
                        "–ù–∞–ø–∏—à–∏ –º–Ω–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–≤—É—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä: 'iPhone 14 –∏ Galaxy S23', "
                        "–∏ —è —Å—Ä–∞–≤–Ω—é –∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –ø–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã.")


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@router.message()
async def compare_phones(message: Message):
    user_input = message.text

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    if " –∏ " in user_input or " vs " in user_input.lower():
        await message.reply("–°—Ä–∞–≤–Ω–∏–≤–∞—é —Ç–µ–ª–µ—Ñ–æ–Ω—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ...")

        try:
            # –ó–∞–ø—Ä–æ—Å –∫ OpenRouter API
            completion = client.chat.completions.create(
                model="deepseek/deepseek-chat-v3-0324:free",
                messages=[{
                    "role": "user",
                    "content": f"""–°—Ä–∞–≤–Ω–∏ –¥–≤–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞: {user_input}.
                1. –î–∞–π –æ—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (—ç–∫—Ä–∞–Ω, –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä, –∫–∞–º–µ—Ä–∞, –±–∞—Ç–∞—Ä–µ—è, –ø–∞–º—è—Ç—å, –û–° –∏ —Ç.–ø.).
                2. –£–∫–∞–∂–∏ —Å–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∫–∞–∂–¥–æ–≥–æ.
                3. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–æ–≤, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å emoji (‚úÖ, ‚ùå, üîã –∏ —Ç.–ø.).
                4. –°–¥–µ–ª–∞–π –≤—ã–≤–æ–¥: –∫–∞–∫–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω –ª—É—á—à–µ –∏ –∫–æ–º—É –ø–æ–¥–æ–π–¥—ë—Ç.
                ‚ö†Ô∏è –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–≤—ã—á–∫–∏ ("", '', *, #, ¬´¬ª, ‚Äû‚Äú –∏ —Ç.–ø.) –≤–æ–æ–±—â–µ ‚Äî –Ω–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö, –Ω–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö.
                –ü–∏—à–∏ –∫–∞–∫ Telegram-—Å–æ–æ–±—â–µ–Ω–∏–µ: —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏, —Å–ø–∏—Å–∫–∞–º–∏, –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Markdown –∏–ª–∏ HTML.
                –Ø–∑—ã–∫ ‚Äî —Ä—É—Å—Å–∫–∏–π. –°—Ç–∏–ª—å ‚Äî –ø—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π, –±–µ–∑ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏.
                –ï—Å–ª–∏ –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ç–µ–±–µ –º–æ–¥–µ–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –ø–∏—à–∏ —á—Ç–æ —è –Ω–µ –∑–Ω–∞—é —Ç–∞–∫–∏–µ –º–æ–¥–µ–ª–∏ –∏ –Ω–µ –º–æ–≥—É –∏—Ö —Å—Ä–∞–≤–Ω–∏—Ç—å."""
                }])

            response = completion.choices[0].message.content
            cleaned = (response.replace('"', '').replace("¬´", "").replace
                       ("¬ª", "").replace("‚Äú", "").replace("‚Äù", "").replace(
                "‚Äò", "").replace("‚Äô", "").replace("###", "").
                       replace("####", "").replace("**", "").replace("#", ""))

            # –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —á–∞—Å—Ç–∏
            for i in range(0, len(cleaned), 4096):
                await message.answer(cleaned[i:i + 4096])

        except Exception as e:
            print(f"Error: {e}")
            await message.reply("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
    else:
        await message.reply(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –¥–≤–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ '–∏' –∏–ª–∏ 'vs', –Ω–∞–ø—Ä–∏–º–µ—Ä: 'iPhone 14 –∏ Galaxy S23'")
